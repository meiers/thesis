\usepackage{fontspec}
\usepackage{etoolbox} % programming tools, e.g. newrobustcmd or ifstrequal
\usepackage{csquotes} % fixes warning in polyglossia
\usepackage{polyglossia} % replaces Babel
\usepackage{setspace}
\usepackage[l2tabu, orthodox]{nag} % better warnings
\usepackage{graphicx}
\usepackage{marginnote} % /marginpar
\usepackage[natbib, backend=biber, style=authoryear, maxcitenames=2, maxbibnames=99, useprefix]{biblatex}
\usepackage{xcolor} % e.g. for black!50
\usepackage{adjustbox} % for chapter style
\usepackage[macros,xspace]{acro} % acronyms (i.e. abbreviations)
\usepackage{hyperref}




\setdefaultlanguage[variant=uk]{english}
\setmainfont[Mapping=tex-text, Numbers=OldStyle]{TeX Gyre Pagella}
\setsansfont[Mapping=tex-text, Numbers=OldStyle]{Droid Sans}
\setmonofont{Droid Sans Mono}

\addbibresource{references.bib}

\setstretch{1.1}

\graphicspath{{figs/}}


% Chapter style
\renewcommand*\chapterheadstartvskip{\vspace*{0\textheight}}
\renewcommand*\chapterheadendvskip{\vspace*{.1\textheight}}
\setkomafont{chapter}{\rmfamily\fontsize{28}{32}\mdseries}

\makeatletter
\renewcommand*{\@@makechapterhead}[1]{%
    \chapterheadstartvskip
    \noindent
    \begingroup
        \usekomafont{chapter}%
        \makebox[\textwidth][l]{%
            \begin{adjustbox}{minipage=\textwidth, valign=t}%
                \hyphenpenalty=10000%
                \exhyphenpenalty=10000%
                \raggedright\noindent#1%

            \end{adjustbox}%
            \hspace{\marginparsep}%
            \begin{adjustbox}{minipage=\marginparwidth, valign=t}
                \ifnumbered{chapter}{\rmfamily%
                 \color{black!60}%
                 \addfontfeature{Numbers=Lining}%
                 \fontsize{150}{150}%
                 \mdseries%
                 \thechapter}\fi%
            \end{adjustbox}%
        }%
    \endgroup
    \chapterheadendvskip
}
\makeatother

%% Abbreviation list
\newcommand*\listofabbrev{%
    \chapter*{List of abbreviations}%
    \addcontentsline{toc}{chapter}{List of abbreviations}%
    \printacronyms[heading=none, name={List of abbreviations}]%
}

%% Reference list
\newcommand*\listofreferences{%
    \chapter*{Bibliography}
    \addcontentsline{toc}{chapter}{Bibliography}%
    \printbibliography[heading=none]%
}

%% Figures
\newcommand*\marginfig[1]{\includegraphics[width=\marginparwidth]{#1}}

%% Quotes
\renewcommand*\dictumwidth{0.75\textwidth}
\setkomafont{dictumtext}{\itshape\small}
\setkomafont{dictumauthor}{\normalfont}

%% Cite (Bibliography). See http://merkel.texture.rocks/Latex/natbib.php
\AtEveryCite{%
    \let\bibopenparen=\bibopenbracket%
\let\bibcloseparen=\bibclosebracket}

%% Custom macros
\newcommand\margintext[1]{%
    \ifstrequal{#1}{}{}{{\marginpar{\raggedright\footnotesize\itshape #1}}}}
\newcommand\explain[2]{%
    \textbf{\color{black!70} #1}%
    \margintext{\textbf{#1}\quad #2}}

\newcommand\todo[1]{%
    \marginpar{\footnotesize\color{red}\textbf{TO\ DO:}\\#1}}

%% Custom macros (not mine)
\newcommand*\captitle[1]{\textbf{#1}}

\newcommand*\gene[1]{\textit{#1}}
\newcommand*\ko[1]{\textit{#1\textsuperscript{\(-/-\)}}}
\newcommand*\protein[1]{#1}
\newcommand*\species[1]{\textit{#1}}
