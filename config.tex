\usepackage{fontspec}
\usepackage{lmodern} % Remove LaTeX Font Warnings
\usepackage{etoolbox} % programming tools, e.g. newrobustcmd or ifstrequal
\usepackage{csquotes} % fixes warning in polyglossia
\usepackage{polyglossia} % replaces Babel
\usepackage{setspace}
\usepackage[l2tabu, orthodox]{nag} % better warnings
\usepackage{graphicx}
\usepackage{marginnote} % /marginpar
\usepackage[natbib, backend=biber, style=authoryear, maxcitenames=2, maxbibnames=99, useprefix]{biblatex}
\usepackage{xcolor} % e.g. for black!50
\usepackage[export]{adjustbox} % for chapter style. Need export for the "inner" option in \includegraphics
\usepackage[section]{placeins}
\usepackage{booktabs}
\usepackage{longtable}
\usepackage{tabu}
\usepackage{caption}
\usepackage{relsize}
\usepackage[macros,xspace]{acro} % acronyms (i.e. abbreviations)
\usepackage{hyperref}
\RequirePackage[nameinlink, noabbrev]{cleveref} % load LAST




\setdefaultlanguage[variant=uk]{english}
\setmainfont[Mapping=tex-text, Numbers=OldStyle]{TeX Gyre Pagella}
\setsansfont[Mapping=tex-text, Numbers=OldStyle]{Barlow}
\setmonofont{Droid Sans Mono}

\addbibresource{references.bib}

\setstretch{1.1}

\graphicspath{{figs/}}


% Chapter style
\renewcommand*\chapterheadstartvskip{\vspace*{0\textheight}}
\renewcommand*\chapterheadendvskip{\vspace*{.1\textheight}}
\setkomafont{chapter}{\rmfamily\fontsize{28}{32}\mdseries}
\makeatletter
\renewcommand*{\@@makechapterhead}[1]{%
    \chapterheadstartvskip
    \noindent
    \begingroup
        \usekomafont{chapter}%
        \makebox[\textwidth][l]{%
            \begin{adjustbox}{minipage=\textwidth, valign=t}%
                \hyphenpenalty=10000%
                \exhyphenpenalty=10000%
                \raggedright\noindent#1%

            \end{adjustbox}%
            \hspace{\marginparsep}%
            \begin{adjustbox}{minipage=\marginparwidth, valign=t}
                \ifnumbered{chapter}{\rmfamily%
                 \color{black!60}%
                 \addfontfeature{Numbers=Lining}%
                 \fontsize{150}{150}%
                 \mdseries%
                 \thechapter}\fi%
            \end{adjustbox}%
        }%
    \endgroup
    \chapterheadendvskip
}
\makeatother

%% Lists in the front/back matter
\newcommand*\listofabbrev{%
    \cleardoublepage
    \phantomsection
    \chapter*{List of abbreviations}%
    \addcontentsline{toc}{chapter}{List of abbreviations}%
    \printacronyms[heading=none,exclude-classes={noprint,tools,people},name={List of abbreviations}]%
}
\newcommand*\listofreferences{%
    \cleardoublepage
    \phantomsection
    \chapter*{Bibliography}
    \addcontentsline{toc}{chapter}{Bibliography}%
    \printbibliography[heading=none]%
}
\newcommand*\listoffigs{%
    \cleardoublepage
    \phantomsection
    \addcontentsline{toc}{chapter}{\listfigurename}
    \listoffigures
}
\newcommand*\listoftabs{%
    \cleardoublepage
    \phantomsection
    \addcontentsline{toc}{chapter}{\listtablename}
    \listoftables
}


%% Figures
\newcommand*\marginfig[1]{\includegraphics[width=\marginparwidth]{#1}}
\newlength{\textplusmargin}
\setlength{\textplusmargin}{\textwidth}
\addtolength{\textplusmargin}{\marginparwidth}
\addtolength{\textplusmargin}{\marginparsep}
% Environments \figure -textwidth -textplusmargin
%     1 = file
%     2 = label
%     3 = caption title
%     4 = caption text
\newcommand*\figuretextwidth[4]{%
    \begin{figure}[!ht]
        \includegraphics[width=\textwidth,center]{#1}%
        \figcap{#2}{#3}{#4}
    \end{figure}
}
\newcommand*\figuretextplusmargin[4]{%
    \begin{figure}[!ht]
        \includegraphics[width=\textplusmargin,inner]{#1}%
        \figcap{#2}{#3}{#4}
    \end{figure}
}
\newcommand*\figuretwocolumns[8]{%
    \begin{figure}[!ht]
        \begin{adjustbox}{inner,minipage=[b]{\textplusmargin}}
            \begin{minipage}[b]{0.48\textplusmargin}
                \includegraphics[width=0.48\textplusmargin]{#1}
            \end{minipage}
            \hspace{0.04\textplusmargin}
            \begin{minipage}[b]{0.48\textplusmargin}
                \includegraphics[width=0.48\textplusmargin]{#5}
            \end{minipage}\\[-\baselineskip]%
            \begin{minipage}[t]{0.48\textplusmargin}
                \centering
                \figcap{#2}{#3}{#4}
            \end{minipage}
            \hspace{0.04\textplusmargin}
            \begin{minipage}[t]{0.48\textplusmargin}
                \centering
                \figcap{#6}{#7}{#8}
            \end{minipage}
        \end{adjustbox}
    \end{figure}
}


%% Captions
\captionsetup{%
    format=plain,
    font={sf,footnotesize},
    labelfont={bf},
    labelformat=simple,
    labelsep=colon,
    justification=justified}
\newcommand*\figcap[3]{\caption[#2]{\label{fig:#1}\textbf{#2.\enspace} #3}}
\newcommand*\tabcap[3]{\caption[#2]{\label{tab:#1}\textbf{#2.\enspace} #3}}

%% Quotes
\renewcommand*\dictumwidth{0.75\textwidth}
\setkomafont{dictumtext}{\itshape\small}
\setkomafont{dictumauthor}{\normalfont}

%% Cite (Bibliography). See http://merkel.texture.rocks/Latex/natbib.php
\AtEveryCite{%
    \let\bibopenparen=\bibopenbracket%
\let\bibcloseparen=\bibclosebracket}
\renewcommand{\UrlFont}{\smaller\ttfamily}

%% Refer to a previously used footnote
% https://tex.stackexchange.com/questions/35043/reference-different-places-to-the-same-footnote
\makeatletter
\newcommand\footnoteref[1]{\protected@xdef\@thefnmark{\ref{#1}}\@footnotemark}
\makeatother

%% Custom macros
\newcommand\margintext[1]{%
    \ifstrequal{#1}{}{}{{\marginpar{\raggedright\footnotesize\itshape #1}}}}
\newcommand\explain[2]{%
    \textbf{\color{black!70} #1}%
    \margintext{\textbf{#1}\quad #2}}

\newcommand\todo[1]{%
    \marginpar{\footnotesize\color{red}\textbf{TO\ DO:}\\#1}}

%% Custom macros (not mine)
\newcommand*\captitle[1]{\textbf{#1}}

\newcommand*\gene[1]{\textit{#1}}
\newcommand*\ko[1]{\textit{#1\textsuperscript{\(-/-\)}}}
\newcommand*\protein[1]{#1}
\newcommand*\species[1]{\textit{#1}}
